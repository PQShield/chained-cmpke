#include "ntt_1907713_1536.h"

#define R2ONPQ -1705988919
#define R2ONP  -284471
#define QINV  -1695357951

#define N     1536
#define M     3
#define INT   int32_t
#define DINT  int64_t
#define DUINT uint64_t
#define LOGR  32
#define Q     1907713

static INT zetas[] =  { 705333, -294443, 615861, 659370, 764256, -710927, 734332, 843297, -198634, 700008, -327467, 383603, 336977, 514544, -279841, -84155, 622248, 810620, -30911, -494246, 930668, -787477, -181681, 827276, 212837, 676061, -691352, 943030, -458026, -329710, -518472, -727670, -649967, 286858, 202623, -879142, -302755, 208349, 195443, -122943, 473367, -700674, -847659, 825481, 717890, 585955, -336464, -122466, 498817, -880853, 92210, 387613, 290241, 598956, 592885, 26866, 443953, 462400, 287274, 517942, 202297, -142833, -599356, 784056, -520501, -106660, 88366, 268507, -396768, 305819, -33047, 807327, 568488, 409401, 789456, 609849, -53450, 408395, 481006, 98805, 656094, 662300, 653230, 764132, -188414, 6241, -130694, 287974, -26145, -34906, -640587, -323754, 20680, 223890, -299959, -477234, 359720, -544557, -62778, -666745, -759177, 855396, 924161, 163274, -61474, 203445, -815127, -896076, 556837, -492553, -160808, -69417, -278374, -535976, 687081, 13479, -667088, 176221, 194230, -127773, 245429, -642640, 516319, -501336, -123715, 471463, -169064, 202817, -342932, -436029, 675713, 502939, -634266, -234103, 657804, 697418, 407267, -652476, 496709, 99996, -465152, -737111, 439301, -757684, -164272, -180719, 296423, 645590, 582328, 492819, 223403, 652079, -786815, 207474, 742583, -734317, 302391, 145637, -892364, 811035, -946559, -603177, 672965, 366179, -496108, 374214, -885456, -372455, -138948, -825353, -545795, 739402, 775360, 460930, 443384, 711770, 41791, 416469, 817512, -259815, 335426, 20824, 267277, -716062, -843169, -186774, -877422, 535542, -863916, -733339, 609741, -369969, -293082, -215515, -848996, 878348, 503256, 53720, 420528, 884978, 644292, 399843, -297888, 328383, 81412, 888779, 195125, 794261, 39513, 891797, -787238, 419680, -918893, -275979, 614658, -550126, -396685, -917429, 5324, -754153, 784767, -731482, 723996, -132057, 477513, 47151, 287569, -680871, -719184, -753098, 657626, 11002, 711954, -98225, 918618, -934540, 625490, 194440, -416859, -669060, 678270, 374721, -472103, 666389, -688629, 276029, 716729, 803086, 106085, 70126, 637879, -816244, -395478, -571342, 770182, -729794 };
static INT izetas[] = { -705333, -294443, 659370, 615861, 843297, 734332, -710927, 764256, -84155, -279841, 514544, 336977, 383603, -327467, 700008, -198634, -727670, -518472, -329710, -458026, 943030, -691352, 676061, 212837, 827276, -181681, -787477, 930668, -494246, -30911, 810620, 622248, 784056, -599356, -142833, 202297, 517942, 287274, 462400, 443953, 26866, 592885, 598956, 290241, 387613, 92210, -880853, 498817, -122466, -336464, 585955, 717890, 825481, -847659, -700674, 473367, -122943, 195443, 208349, -302755, -879142, 202623, 286858, -649967, 202817, -169064, 471463, -123715, -501336, 516319, -642640, 245429, -127773, 194230, 176221, -667088, 13479, 687081, -535976, -278374, -69417, -160808, -492553, 556837, -896076, -815127, 203445, -61474, 163274, 924161, 855396, -759177, -666745, -62778, -544557, 359720, -477234, -299959, 223890, 20680, -323754, -640587, -34906, -26145, 287974, -130694, 6241, -188414, 764132, 653230, 662300, 656094, 98805, 481006, 408395, -53450, 609849, 789456, 409401, 568488, 807327, -33047, 305819, -396768, 268507, 88366, -106660, -520501, -729794, 770182, -571342, -395478, -816244, 637879, 70126, 106085, 803086, 716729, 276029, -688629, 666389, -472103, 374721, 678270, -669060, -416859, 194440, 625490, -934540, 918618, -98225, 711954, 11002, 657626, -753098, -719184, -680871, 287569, 47151, 477513, -132057, 723996, -731482, 784767, -754153, 5324, -917429, -396685, -550126, 614658, -275979, -918893, 419680, -787238, 891797, 39513, 794261, 195125, 888779, 81412, 328383, -297888, 399843, 644292, 884978, 420528, 53720, 503256, 878348, -848996, -215515, -293082, -369969, 609741, -733339, -863916, 535542, -877422, -186774, -843169, -716062, 267277, 20824, 335426, -259815, 817512, 416469, 41791, 711770, 443384, 460930, 775360, 739402, -545795, -825353, -138948, -372455, -885456, 374214, -496108, 366179, 672965, -603177, -946559, 811035, -892364, 145637, 302391, -734317, 742583, 207474, -786815, 652079, 223403, 492819, 582328, 645590, 296423, -180719, -164272, -757684, 439301, -737111, -465152, 99996, 496709, -652476, 407267, 697418, 657804, -234103, -634266, 502939, 675713, -436029, -342932 };

// Returns x mod q provided -q â‰¤ x < q.
static INT freeze(INT x) {
    x += (x >> 31) & Q;
    x -= (((Q-1)/2 - x) >> 31) & Q;
    return x;
}

// Montgomery reduction.
static INT reduce (DINT x) {
    DINT m = (INT)(x * QINV);
    return (INT)((DUINT)(x - m*Q) >> LOGR);
}

void ntt_1907713_1536(INT pp[N])
{
    int l, off, j, k;
    INT zeta, zeta_b;

    for (l = N >> 1; l >= M; l >>= 1) {
        k = 0;
        for (off = 0; off < N - l; off += 2*l) {
            zeta = zetas[k++];

            for (j = off; j < off+l; j++) {
                zeta_b = reduce(zeta * (DINT)pp[j+l]);
                pp[j+l] = pp[j] - zeta_b;
                pp[j] += zeta_b;
            }
        }
    }
}

void ntt_1907713_1536_inverse(INT pp[N])
{
    int l, off, j, k;
    INT zeta, bma;

    for (l = M; l < N; l <<= 1) {
        k = 0;
        for (off = 0; off < N - l; off += 2*l) {
            zeta = izetas[k++];

            for (j = off; j < off+l; j++) {
                bma = pp[j+l] - pp[j];
                pp[j] += pp[j+l];
                pp[j+l] = reduce(zeta * (DINT)bma);
            }
        }
    }

    for (int i = 0; i < N; i++) {
        // Multiply p with R^2/n and reduce completely.
        DINT x = pp[i];
        DINT m = (INT)(x * R2ONPQ);
        pp[i] = freeze((DUINT)(x * R2ONP - m*Q) >> LOGR);
    }
}

void ntt_1907713_1536_mul(int32_t pp[1536], int32_t qq[1536])
{
    int i, k = 0;
    INT zeta;
    INT r0, r1, r2;
    DINT p0, p1, p2, q0, q1, q2;
    for (i = 0; i < N; i += 6) {
        zeta = zetas[k++];

        p0 = pp[i]; p1 = pp[i+1]; p2 = pp[i+2];
        q0 = qq[i]; q1 = qq[i+1]; q2 = qq[i+2];

        r0 = reduce(p1*q2 + p2*q1);
        r0 = reduce(zeta*(DINT)r0 + p0*q0);

        r1 = reduce(p2*q2);
        r1 = reduce(zeta*(DINT)r1 + p1*q0 + p0*q1);

        r2 = reduce(p0*q2 + p1*q1 + p2*q0);

        pp[i] = r0;
        pp[i+1] = r1;
        pp[i+2] = r2;

        p0 = pp[i+3]; p1 = pp[i+4]; p2 = pp[i+5];
        q0 = qq[i+3]; q1 = qq[i+4]; q2 = qq[i+5];

        r0 = reduce(p1*q2 + p2*q1);
        r0 = reduce(-zeta*(DINT)r0 + p0*q0);

        r1 = reduce(p2*q2);
        r1 = reduce(-zeta*(DINT)r1 + p1*q0 + p0*q1);

        r2 = reduce(p0*q2 + p1*q1 + p2*q0);

        pp[i+3] = r0;
        pp[i+4] = r1;
        pp[i+5] = r2;
    }
}
